name: build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
      
jobs:
  BuildTestAndAnalyze:
    name: Image ${{ matrix.image }}
    strategy:
      matrix:
        image: ["swift:6.2.3-noble"]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install dependencies
        run: apt-get update && apt-get install -y libssl-dev curl unzip
      - uses: actions/checkout@v6
      - name: Build
        run: swift build -c release -Xswiftc -strict-concurrency=complete
      - name: Run tests
        run: swift test -v 2>&1 | tee build.log
      - name: Install SwiftLint
        run: |
          curl -sL https://github.com/realm/SwiftLint/releases/download/0.63.2/swiftlint_linux_amd64.zip -o swiftlint.zip
          unzip -o swiftlint.zip -d /usr/local/bin
          chmod +x /usr/local/bin/swiftlint
      - name: SwiftLint unused imports
        run: swiftlint analyze --strict --quiet --compiler-log-path build.log
  BuildAndTest:
    name: Image ${{ matrix.image }}
    strategy:
      matrix:
        image: ["swift:6.2.3-jammy"]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install libssl-dev
        run: apt-get update && apt-get install -y libssl-dev
      - uses: actions/checkout@v6
      - name: Build
        run: swift build -c release -Xswiftc -strict-concurrency=complete
      - name: Run tests
        run: swift test
  SwiftLint:
    name: SwiftLint version 3.2.1
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: GitHub Action for SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
  SwiftFormat:
    name: swift-format
    runs-on: ubuntu-latest
    container:
      image: swift:6.2.3-noble
    steps:
      - uses: actions/checkout@v6
      - name: Run swift-format
        run: swift-format format --recursive --in-place .
      - name: Check for formatting differences
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git diff --exit-code